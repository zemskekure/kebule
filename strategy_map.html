<!DOCTYPE html>
<html lang="cs">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategická mapa gastronomie</title>
    
    <!-- React & ReactDOM -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    
    <!-- Babel for JSX -->
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    
    <!-- Lucide Icons -->
    <script src="https://unpkg.com/lucide@latest"></script>

    <style>
        :root {
            --bg-color: #f8f9fa;
            --text-color: #212529;
            --border-color: #dee2e6;
            --primary-color: #0d6efd;
            --primary-hover: #0b5ed7;
            --secondary-color: #6c757d;
            --success-color: #198754;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --white: #ffffff;
            --shadow: 0 2px 4px rgba(0,0,0,0.05);
            --shadow-lg: 0 4px 6px rgba(0,0,0,0.1);
        }

        * {
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            margin: 0;
            padding: 0;
            height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Layout */
        #root {
            height: 100%;
            display: flex;
            flex-direction: column;
        }

        .app-container {
            display: flex;
            flex: 1;
            overflow: hidden;
        }

        /* Header */
        header {
            background-color: var(--white);
            border-bottom: 1px solid var(--border-color);
            padding: 1rem 2rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
            z-index: 10;
        }

        h1 {
            margin: 0;
            font-size: 1.25rem;
            font-weight: 600;
        }

        .header-actions {
            display: flex;
            gap: 0.5rem;
        }

        /* Panels */
        .panel {
            background-color: var(--white);
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-left {
            width: 280px;
            border-right: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .panel-center {
            flex: 1;
            background-color: #f0f2f5;
            overflow: auto;
            position: relative;
            padding: 2rem;
        }

        .panel-right {
            width: 350px;
            border-left: 1px solid var(--border-color);
            flex-shrink: 0;
        }

        .panel-header {
            padding: 1rem;
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
            background-color: var(--white);
        }

        .panel-content {
            padding: 1rem;
            overflow-y: auto;
            flex: 1;
        }

        /* Components */
        .btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            padding: 0.375rem 0.75rem;
            font-size: 0.9rem;
            font-weight: 500;
            line-height: 1.5;
            color: var(--text-color);
            background-color: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn:hover {
            background-color: #e9ecef;
        }

        .btn-primary {
            color: var(--white);
            background-color: var(--primary-color);
            border-color: var(--primary-color);
        }

        .btn-primary:hover {
            background-color: var(--primary-hover);
            border-color: var(--primary-hover);
        }

        .btn-danger {
            color: var(--white);
            background-color: var(--danger-color);
            border-color: var(--danger-color);
        }

        .btn-danger:hover {
            background-color: #bb2d3b;
        }

        .btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.8rem;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            font-size: 0.9rem;
        }

        .form-control {
            display: block;
            width: 100%;
            padding: 0.375rem 0.75rem;
            font-size: 0.9rem;
            line-height: 1.5;
            color: var(--text-color);
            background-color: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 0.25rem;
            transition: border-color 0.15s ease-in-out;
        }

        .form-control:focus {
            border-color: var(--primary-color);
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
        }

        textarea.form-control {
            min-height: 100px;
            resize: vertical;
        }

        /* Brand List & Filters */
        .brand-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .brand-item {
            display: flex;
            align-items: center;
            padding: 0.5rem 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .brand-item:last-child {
            border-bottom: none;
        }

        .brand-checkbox {
            margin-right: 0.75rem;
        }

        .add-brand-form {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1rem;
        }

        /* Mind Map Tree */
        .tree-node {
            margin-bottom: 1rem;
            position: relative;
        }

        .node-content {
            background: var(--white);
            border: 1px solid var(--border-color);
            border-radius: 6px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.2s;
            box-shadow: var(--shadow);
            position: relative;
            display: flex;
            align-items: flex-start;
            gap: 0.5rem;
        }

        .node-content:hover {
            box-shadow: var(--shadow-lg);
            border-color: #adb5bd;
        }

        .node-content.selected {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 2px rgba(13, 110, 253, 0.25);
        }

        .node-toggle {
            background: none;
            border: none;
            cursor: pointer;
            padding: 0;
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            justify-content: center;
            width: 20px;
            height: 20px;
        }
        
        .node-toggle:hover {
            color: var(--text-color);
        }

        .node-body {
            flex: 1;
        }

        .node-title {
            font-weight: 600;
            margin-bottom: 0.25rem;
        }

        .node-desc {
            font-size: 0.85rem;
            color: var(--secondary-color);
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: 300px;
        }

        .node-badges {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
            flex-wrap: wrap;
        }

        .badge {
            display: inline-block;
            padding: 0.25em 0.5em;
            font-size: 0.75em;
            font-weight: 700;
            line-height: 1;
            text-align: center;
            white-space: nowrap;
            vertical-align: baseline;
            border-radius: 0.25rem;
            color: var(--white);
        }

        .badge-priority-low { background-color: var(--success-color); }
        .badge-priority-medium { background-color: var(--warning-color); color: #000; }
        .badge-priority-high { background-color: var(--danger-color); }
        
        .badge-status-idea { background-color: var(--secondary-color); }
        .badge-status-prep { background-color: var(--warning-color); color: #000; }
        .badge-status-running { background-color: var(--primary-color); }
        .badge-status-done { background-color: var(--success-color); }

        .badge-brands {
            background-color: #e9ecef;
            color: var(--text-color);
            border: 1px solid #ced4da;
        }

        .children-container {
            margin-left: 2rem;
            border-left: 2px solid #e9ecef;
            padding-left: 1rem;
        }
        
        .empty-state {
            text-align: center;
            color: var(--secondary-color);
            padding: 2rem;
        }

        /* Levels styling */
        .level-big-thought > .node-content {
            border-left: 4px solid var(--primary-color);
        }
        
        .level-theme > .node-content {
            border-left: 4px solid var(--warning-color);
        }
        
        .level-project > .node-content {
            border-left: 4px solid var(--success-color);
        }

        .add-btn-container {
            margin-top: 0.5rem;
            margin-bottom: 1rem;
        }

    </style>
</head>
<body>
    <div id="root"></div>

    <script type="text/babel">
        const { useState, useEffect, useMemo } = React;
        const { Plus, Minus, ChevronRight, ChevronDown, Save, Trash2, Download, Upload, FolderPlus, FilePlus, Lightbulb, Check } = lucide;

        // --- Types & Initial Data ---

        const INITIAL_BRANDS = [
            { id: 'b1', name: 'Lokál' },
            { id: 'b2', name: 'Eska' },
            { id: 'b3', name: 'Café Savoy' },
            { id: 'b4', name: 'Brasileiro' },
            { id: 'b5', name: 'Čestr' },
        ];

        const INITIAL_BIG_THOUGHT = {
            id: 'bt1',
            title: 'Ambiente jako brána do české gastronomie',
            description: 'Hlavní vize pro následující 3 roky.',
        };

        const INITIAL_THEMES = [
            { id: 't1', bigThoughtId: 'bt1', title: 'Digitalizace', description: 'Zlepšení procesů pomocí technologií.', priority: 'Vysoká' },
            { id: 't2', bigThoughtId: 'bt1', title: 'Udržitelnost', description: 'Ekologie a zero waste.', priority: 'Střední' },
        ];

        const INITIAL_PROJECTS = [
            { id: 'p1', themeId: 't1', title: 'Nová mobilní aplikace', description: 'Věrnostní program pro hosty.', status: 'V přípravě', brands: ['b1', 'b2'] },
        ];

        const STORAGE_KEY = 'strategieAmbiente';

        // --- Hooks ---

        function useLocalStorage(key, initialValue) {
            const [storedValue, setStoredValue] = useState(() => {
                try {
                    const item = window.localStorage.getItem(key);
                    return item ? JSON.parse(item) : initialValue;
                } catch (error) {
                    console.error(error);
                    return initialValue;
                }
            });

            const setValue = (value) => {
                try {
                    const valueToStore = value instanceof Function ? value(storedValue) : value;
                    setStoredValue(valueToStore);
                    window.localStorage.setItem(key, JSON.stringify(valueToStore));
                } catch (error) {
                    console.error(error);
                }
            };

            return [storedValue, setValue];
        }

        // --- Components ---

        function App() {
            // State
            const [data, setData] = useLocalStorage(STORAGE_KEY, {
                brands: INITIAL_BRANDS,
                bigThoughts: [INITIAL_BIG_THOUGHT],
                themes: INITIAL_THEMES,
                projects: INITIAL_PROJECTS
            });

            const [selectedNode, setSelectedNode] = useState(null); // { type: 'bigThought'|'theme'|'project', id: string }
            const [selectedBrandIds, setSelectedBrandIds] = useState([]);
            const [expandedNodes, setExpandedNodes] = useState({}); // { [id]: boolean }

            // Actions
            const addBrand = (name) => {
                if (!name.trim()) return;
                const newBrand = { id: Date.now().toString(), name };
                setData(prev => ({ ...prev, brands: [...prev.brands, newBrand] }));
            };

            const toggleBrandFilter = (id) => {
                setSelectedBrandIds(prev => 
                    prev.includes(id) ? prev.filter(bId => bId !== id) : [...prev, id]
                );
            };

            const toggleNode = (id) => {
                setExpandedNodes(prev => ({ ...prev, [id]: !prev[id] }));
            };

            const selectNode = (type, id) => {
                setSelectedNode({ type, id });
            };

            const updateNode = (type, id, updates) => {
                setData(prev => {
                    const collectionName = type === 'bigThought' ? 'bigThoughts' : (type === 'theme' ? 'themes' : 'projects');
                    const collection = prev[collectionName];
                    const updatedCollection = collection.map(item => item.id === id ? { ...item, ...updates } : item);
                    return { ...prev, [collectionName]: updatedCollection };
                });
            };

            const deleteNode = (type, id) => {
                if (!window.confirm('Opravdu chcete smazat tento záznam?')) return;
                
                setData(prev => {
                    let newState = { ...prev };
                    if (type === 'bigThought') {
                        newState.bigThoughts = prev.bigThoughts.filter(bt => bt.id !== id);
                        // Cascade delete
                        const themesToDelete = prev.themes.filter(t => t.bigThoughtId === id).map(t => t.id);
                        newState.themes = prev.themes.filter(t => t.bigThoughtId !== id);
                        newState.projects = prev.projects.filter(p => !themesToDelete.includes(p.themeId));
                    } else if (type === 'theme') {
                        newState.themes = prev.themes.filter(t => t.id !== id);
                        newState.projects = prev.projects.filter(p => p.themeId !== id);
                    } else if (type === 'project') {
                        newState.projects = prev.projects.filter(p => p.id !== id);
                    }
                    return newState;
                });
                setSelectedNode(null);
            };

            const addBigThought = () => {
                const newId = Date.now().toString();
                const newBT = { id: newId, title: 'Nová velká myšlenka', description: '' };
                setData(prev => ({ ...prev, bigThoughts: [...prev.bigThoughts, newBT] }));
                setExpandedNodes(prev => ({ ...prev, [newId]: true }));
                selectNode('bigThought', newId);
            };

            const addTheme = (bigThoughtId) => {
                const newId = Date.now().toString();
                const newTheme = { id: newId, bigThoughtId, title: 'Nové téma', description: '', priority: 'Střední' };
                setData(prev => ({ ...prev, themes: [...prev.themes, newTheme] }));
                setExpandedNodes(prev => ({ ...prev, [bigThoughtId]: true, [newId]: true }));
                selectNode('theme', newId);
            };

            const addProject = (themeId) => {
                const newId = Date.now().toString();
                const newProject = { id: newId, themeId, title: 'Nový projekt', description: '', status: 'Nápad', brands: [] };
                setData(prev => ({ ...prev, projects: [...prev.projects, newProject] }));
                setExpandedNodes(prev => ({ ...prev, [themeId]: true }));
                selectNode('project', newId);
            };

            const exportData = () => {
                const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
                const downloadAnchorNode = document.createElement('a');
                downloadAnchorNode.setAttribute("href", dataStr);
                downloadAnchorNode.setAttribute("download", "strategie_ambiente.json");
                document.body.appendChild(downloadAnchorNode);
                downloadAnchorNode.click();
                downloadAnchorNode.remove();
            };

            const importData = (event) => {
                const file = event.target.files[0];
                if (!file) return;
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const json = JSON.parse(e.target.result);
                        if (json.brands && json.bigThoughts && json.themes && json.projects) {
                            setData(json);
                            alert('Data byla úspěšně importována.');
                        } else {
                            alert('Chyba: Neplatný formát JSON souboru.');
                        }
                    } catch (err) {
                        alert('Chyba při čtení souboru.');
                    }
                };
                reader.readAsText(file);
            };

            // Derived state for filtering
            const filteredProjects = useMemo(() => {
                if (selectedBrandIds.length === 0) return data.projects;
                return data.projects.filter(p => 
                    p.brands.some(bId => selectedBrandIds.includes(bId))
                );
            }, [data.projects, selectedBrandIds]);

            const filteredThemes = useMemo(() => {
                if (selectedBrandIds.length === 0) return data.themes;
                const themeIds = new Set(filteredProjects.map(p => p.themeId));
                return data.themes.filter(t => themeIds.has(t.id));
            }, [data.themes, filteredProjects, selectedBrandIds]);

            const filteredBigThoughts = useMemo(() => {
                if (selectedBrandIds.length === 0) return data.bigThoughts;
                const btIds = new Set(filteredThemes.map(t => t.bigThoughtId));
                return data.bigThoughts.filter(bt => btIds.has(bt.id));
            }, [data.bigThoughts, filteredThemes, selectedBrandIds]);


            return (
                <div className="app-container">
                    <Sidebar 
                        brands={data.brands} 
                        selectedBrandIds={selectedBrandIds}
                        onAddBrand={addBrand}
                        onToggleFilter={toggleBrandFilter}
                    />
                    
                    <div className="panel panel-center">
                        <div className="panel-header" style={{display: 'flex', justifyContent: 'space-between', alignItems: 'center'}}>
                            <span>Mapa myšlenek</span>
                            <div className="header-actions">
                                <button className="btn btn-primary btn-sm" onClick={addBigThought}>
                                    <Plus size={16} /> Přidat velkou myšlenku
                                </button>
                                <button className="btn btn-sm" onClick={exportData} title="Exportovat JSON">
                                    <Download size={16} />
                                </button>
                                <label className="btn btn-sm" title="Importovat JSON" style={{cursor: 'pointer'}}>
                                    <Upload size={16} />
                                    <input type="file" style={{display: 'none'}} onChange={importData} accept=".json" />
                                </label>
                            </div>
                        </div>
                        <div className="panel-content">
                            {filteredBigThoughts.length === 0 ? (
                                <div className="empty-state">
                                    <p>Žádná data k zobrazení. Přidejte velkou myšlenku nebo upravte filtry.</p>
                                </div>
                            ) : (
                                filteredBigThoughts.map(bt => (
                                    <BigThoughtNode 
                                        key={bt.id} 
                                        data={bt} 
                                        themes={filteredThemes.filter(t => t.bigThoughtId === bt.id)}
                                        allProjects={filteredProjects}
                                        expanded={!!expandedNodes[bt.id]}
                                        onToggle={() => toggleNode(bt.id)}
                                        selected={selectedNode?.id === bt.id}
                                        onSelect={() => selectNode('bigThought', bt.id)}
                                        onAddTheme={() => addTheme(bt.id)}
                                        onToggleNode={toggleNode}
                                        expandedNodes={expandedNodes}
                                        selectedNode={selectedNode}
                                        onSelectNode={selectNode}
                                        onAddProject={addProject}
                                    />
                                ))
                            )}
                        </div>
                    </div>

                    <DetailPanel 
                        selectedNode={selectedNode}
                        data={data}
                        onUpdate={updateNode}
                        onDelete={deleteNode}
                    />
                </div>
            );
        }

        // --- Sub-components ---

        function Sidebar({ brands, selectedBrandIds, onAddBrand, onToggleFilter }) {
            const [newBrandName, setNewBrandName] = useState('');

            const handleSubmit = (e) => {
                e.preventDefault();
                onAddBrand(newBrandName);
                setNewBrandName('');
            };

            return (
                <div className="panel panel-left">
                    <div className="panel-header">Značky a filtry</div>
                    <div className="panel-content">
                        <div className="form-group">
                            <form onSubmit={handleSubmit} className="add-brand-form">
                                <input 
                                    type="text" 
                                    className="form-control" 
                                    placeholder="Nová značka..." 
                                    value={newBrandName}
                                    onChange={e => setNewBrandName(e.target.value)}
                                />
                                <button type="submit" className="btn btn-sm"><Plus size={16}/></button>
                            </form>
                        </div>
                        <p style={{fontSize: '0.85rem', color: 'var(--secondary-color)', marginBottom: '0.5rem'}}>
                            Filtrovat projekty podle značek:
                        </p>
                        <ul className="brand-list">
                            {brands.map(brand => (
                                <li key={brand.id} className="brand-item">
                                    <label style={{display: 'flex', alignItems: 'center', cursor: 'pointer', width: '100%'}}>
                                        <input 
                                            type="checkbox" 
                                            className="brand-checkbox"
                                            checked={selectedBrandIds.includes(brand.id)}
                                            onChange={() => onToggleFilter(brand.id)}
                                        />
                                        {brand.name}
                                    </label>
                                </li>
                            ))}
                        </ul>
                    </div>
                </div>
            );
        }

        function BigThoughtNode({ data, themes, allProjects, expanded, onToggle, selected, onSelect, onAddTheme, onToggleNode, expandedNodes, selectedNode, onSelectNode, onAddProject }) {
            const { ChevronRight, ChevronDown, Lightbulb } = lucide;
            
            return (
                <div className="tree-node level-big-thought">
                    <div className={`node-content ${selected ? 'selected' : ''}`} onClick={(e) => { e.stopPropagation(); onSelect(); }}>
                        <button className="node-toggle" onClick={(e) => { e.stopPropagation(); onToggle(); }}>
                            {expanded ? <ChevronDown size={18} /> : <ChevronRight size={18} />}
                        </button>
                        <div className="node-body">
                            <div className="node-title" style={{fontSize: '1.1rem'}}>{data.title}</div>
                            {data.description && <div className="node-desc">{data.description}</div>}
                        </div>
                        <Lightbulb size={20} color="var(--primary-color)" />
                    </div>
                    
                    {expanded && (
                        <div className="children-container">
                            {themes.map(theme => (
                                <ThemeNode 
                                    key={theme.id}
                                    data={theme}
                                    projects={allProjects.filter(p => p.themeId === theme.id)}
                                    expanded={!!expandedNodes[theme.id]}
                                    onToggle={() => onToggleNode(theme.id)}
                                    selected={selectedNode?.id === theme.id}
                                    onSelect={() => onSelectNode('theme', theme.id)}
                                    onAddProject={() => onAddProject(theme.id)}
                                    selectedNode={selectedNode}
                                    onSelectNode={onSelectNode}
                                />
                            ))}
                            <div className="add-btn-container">
                                <button className="btn btn-sm" onClick={onAddTheme}>
                                    <Plus size={14} /> Přidat téma
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function ThemeNode({ data, projects, expanded, onToggle, selected, onSelect, onAddProject, selectedNode, onSelectNode }) {
            const { ChevronRight, ChevronDown, FolderPlus } = lucide;

            const priorityColor = {
                'Nízká': 'badge-priority-low',
                'Střední': 'badge-priority-medium',
                'Vysoká': 'badge-priority-high'
            }[data.priority] || 'badge-priority-medium';

            return (
                <div className="tree-node level-theme">
                    <div className={`node-content ${selected ? 'selected' : ''}`} onClick={(e) => { e.stopPropagation(); onSelect(); }}>
                        <button className="node-toggle" onClick={(e) => { e.stopPropagation(); onToggle(); }}>
                            {expanded ? <ChevronDown size={18} /> : <ChevronRight size={18} />}
                        </button>
                        <div className="node-body">
                            <div className="node-title">{data.title}</div>
                            {data.description && <div className="node-desc">{data.description}</div>}
                            <div className="node-badges">
                                <span className={`badge ${priorityColor}`}>{data.priority}</span>
                            </div>
                        </div>
                    </div>

                    {expanded && (
                        <div className="children-container">
                            {projects.map(project => (
                                <ProjectNode 
                                    key={project.id}
                                    data={project}
                                    selected={selectedNode?.id === project.id}
                                    onSelect={() => onSelectNode('project', project.id)}
                                />
                            ))}
                            <div className="add-btn-container">
                                <button className="btn btn-sm" onClick={onAddProject}>
                                    <Plus size={14} /> Přidat projekt
                                </button>
                            </div>
                        </div>
                    )}
                </div>
            );
        }

        function ProjectNode({ data, selected, onSelect }) {
            const { FilePlus } = lucide;

            const statusClass = {
                'Nápad': 'badge-status-idea',
                'V přípravě': 'badge-status-prep',
                'Běží': 'badge-status-running',
                'Hotovo': 'badge-status-done'
            }[data.status] || 'badge-status-idea';

            return (
                <div className="tree-node level-project">
                    <div className={`node-content ${selected ? 'selected' : ''}`} onClick={(e) => { e.stopPropagation(); onSelect(); }}>
                        <div style={{width: '20px'}}></div> {/* Spacer for alignment */}
                        <div className="node-body">
                            <div className="node-title">{data.title}</div>
                            {data.description && <div className="node-desc">{data.description}</div>}
                            <div className="node-badges">
                                <span className={`badge ${statusClass}`}>{data.status}</span>
                                {data.brands.length > 0 && (
                                    <span className="badge badge-brands">{data.brands.length} značky</span>
                                )}
                            </div>
                        </div>
                    </div>
                </div>
            );
        }

        function DetailPanel({ selectedNode, data, onUpdate, onDelete }) {
            if (!selectedNode) {
                return (
                    <div className="panel panel-right">
                        <div className="panel-header">Detail</div>
                        <div className="panel-content" style={{display: 'flex', alignItems: 'center', justifyContent: 'center', textAlign: 'center', color: 'var(--secondary-color)'}}>
                            <p>Vyberte uzel ve stromu vlevo nebo přidejte novou velkou myšlenku.</p>
                        </div>
                    </div>
                );
            }

            const { type, id } = selectedNode;
            let item, parentItem;

            if (type === 'bigThought') {
                item = data.bigThoughts.find(i => i.id === id);
            } else if (type === 'theme') {
                item = data.themes.find(i => i.id === id);
                parentItem = data.bigThoughts.find(bt => bt.id === item?.bigThoughtId);
            } else if (type === 'project') {
                item = data.projects.find(i => i.id === id);
                parentItem = data.themes.find(t => t.id === item?.themeId);
            }

            if (!item) return null; // Should not happen

            const handleChange = (field, value) => {
                onUpdate(type, id, { [field]: value });
            };

            const handleBrandToggle = (brandId) => {
                if (type !== 'project') return;
                const currentBrands = item.brands || [];
                const newBrands = currentBrands.includes(brandId)
                    ? currentBrands.filter(b => b !== brandId)
                    : [...currentBrands, brandId];
                handleChange('brands', newBrands);
            };

            return (
                <div className="panel panel-right">
                    <div className="panel-header">
                        {type === 'bigThought' && 'Editace velké myšlenky'}
                        {type === 'theme' && 'Editace tématu'}
                        {type === 'project' && 'Editace projektu'}
                    </div>
                    <div className="panel-content">
                        <div className="form-group">
                            <label className="form-label">Název</label>
                            <input 
                                type="text" 
                                className="form-control" 
                                value={item.title} 
                                onChange={e => handleChange('title', e.target.value)}
                            />
                            {!item.title.trim() && <small style={{color: 'var(--danger-color)'}}>Název nesmí být prázdný.</small>}
                        </div>

                        <div className="form-group">
                            <label className="form-label">Popis</label>
                            <textarea 
                                className="form-control" 
                                value={item.description} 
                                onChange={e => handleChange('description', e.target.value)}
                            />
                        </div>

                        {type === 'theme' && (
                            <div className="form-group">
                                <label className="form-label">Priorita</label>
                                <select 
                                    className="form-control" 
                                    value={item.priority} 
                                    onChange={e => handleChange('priority', e.target.value)}
                                >
                                    <option value="Nízká">Nízká</option>
                                    <option value="Střední">Střední</option>
                                    <option value="Vysoká">Vysoká</option>
                                </select>
                            </div>
                        )}

                        {type === 'project' && (
                            <>
                                <div className="form-group">
                                    <label className="form-label">Stav</label>
                                    <select 
                                        className="form-control" 
                                        value={item.status} 
                                        onChange={e => handleChange('status', e.target.value)}
                                    >
                                        <option value="Nápad">Nápad</option>
                                        <option value="V přípravě">V přípravě</option>
                                        <option value="Běží">Běží</option>
                                        <option value="Hotovo">Hotovo</option>
                                    </select>
                                </div>
                                <div className="form-group">
                                    <label className="form-label">Přiřazené značky</label>
                                    <div style={{maxHeight: '200px', overflowY: 'auto', border: '1px solid var(--border-color)', padding: '0.5rem', borderRadius: '0.25rem'}}>
                                        {data.brands.map(brand => (
                                            <div key={brand.id} style={{marginBottom: '0.25rem'}}>
                                                <label style={{display: 'flex', alignItems: 'center', cursor: 'pointer'}}>
                                                    <input 
                                                        type="checkbox" 
                                                        style={{marginRight: '0.5rem'}}
                                                        checked={item.brands.includes(brand.id)}
                                                        onChange={() => handleBrandToggle(brand.id)}
                                                    />
                                                    {brand.name}
                                                </label>
                                            </div>
                                        ))}
                                    </div>
                                </div>
                            </>
                        )}

                        {parentItem && (
                            <div style={{marginTop: '1rem', padding: '0.5rem', backgroundColor: '#f8f9fa', borderRadius: '0.25rem', fontSize: '0.85rem'}}>
                                <strong>Patří pod:</strong> {parentItem.title}
                            </div>
                        )}

                        <div style={{marginTop: '2rem', display: 'flex', gap: '0.5rem'}}>
                            {/* Save is automatic, but we can have a visual indicator or explicit button if requested. 
                                The spec asked for "Uložit změny" button, but in React state it's instant. 
                                We can make it just close the panel or show a toast, or just be a dummy button for UX.
                                Let's make it deselect the node to "finish" editing.
                            */}
                            <button className="btn btn-primary" onClick={() => setSelectedNode(null)}>
                                <Save size={16} /> Hotovo
                            </button>
                            <button className="btn btn-danger" onClick={() => onDelete(type, id)}>
                                <Trash2 size={16} /> Smazat
                            </button>
                        </div>
                    </div>
                </div>
            );
        }

        // --- Init ---
        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(<App />);
    </script>
</body>
</html>
